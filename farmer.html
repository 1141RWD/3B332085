<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éœ“è™¹è¾²å¤« - æ¥µé™å¹³è¡¡ç‰ˆ</title>
    <style>
        :root {
            --game-bg: #050510;
            --border-neon: #39ff14;
            --neon-cyan: #00f2fe;
            --zombie-color: #ff00cc;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; height: 100vh;
            background: #020205; color: white; font-family: 'Segoe UI', sans-serif;
            overflow: hidden; touch-action: none; padding-top: 50px;
        }

        /* è¿”å›å¤§å»³æŒ‰éˆ•ç¸®å° */
        #home-btn {
            position: fixed; top: 10px; left: 10px; z-index: 9999;
            padding: 5px 12px; background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--neon-cyan); border-radius: 50px;
            color: var(--neon-cyan); text-decoration: none; font-size: 12px;
            backdrop-filter: blur(5px);
        }

        /* éŠæˆ²å®¹å™¨ï¼šæ‰‹æ©Ÿç‰ˆæ ¹æ“šè¢å¹•å¯¬åº¦è‡ªå‹•ç¸®æ”¾ */
        #game-container {
            position: relative; 
            width: 85vw; height: 85vw; /* ä¿æŒ 1:1 */
            max-width: 400px; max-height: 400px;
            background: var(--game-bg); border: 3px solid var(--border-neon);
            box-shadow: 0 0 15px var(--border-neon); border-radius: 10px; 
            overflow: hidden;
        }

        .player, .zombie, .plant {
            position: absolute; font-size: 1.5em; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
            user-select: none; z-index: 5;
            transition: transform 0.05s linear; /* å¹³æ»‘ç§»å‹• */
        }

        #ui-panel {
            display: flex; justify-content: space-around; 
            width: 85vw; max-width: 400px;
            margin-top: 10px; padding: 8px; background: #0a0a1a; 
            border-radius: 10px; border: 1px solid rgba(57, 255, 20, 0.3);
        }
        .stat { text-align: center; }
        .stat label { display: block; font-size: 10px; color: #aaa; }
        .stat span { font-weight: bold; font-size: 14px; color: var(--border-neon); }

        /* è™›æ“¬æ‰‹æŠŠå„ªåŒ–ï¼šåŠ å¤§ä¸¦èª¿æ•´ä½ç½® */
#controls {
    display: grid; 
    grid-template-areas: 
        ". up ." 
        "left . right" 
        ". down .";
    gap: 15px; /* å¢åŠ é–“è·é¿å…èª¤è§¸ */
    margin-top: 25px; 
    padding-bottom: 30px;
    touch-action: none; /* é˜²æ­¢æ»‘å‹•ç•«é¢ */
}

.control-btn {
    width: 65px;  /* å¾ 50px åŠ å¤§åˆ° 65px */
    height: 65px; 
    background: rgba(0, 242, 254, 0.15); /* å¢åŠ ä¸€é»åº•è‰² */
    border-radius: 15px; /* æ”¹æˆåœ“è§’æ–¹å¡Šæ›´å¥½æŒ‰ */
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 1.8em; /* åœ–æ¨™è®Šå¤§ */
    border: 2px solid var(--neon-cyan); /* ç·šæ¢åŠ ç²— */
    box-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
    color: white;
    user-select: none;
    -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šç°è‰²æ¡† */
}

/* é»æ“Šæ™‚çš„è¦–è¦ºåé¥‹ */
.control-btn:active {
    background: var(--neon-cyan);
    color: #000;
    transform: scale(0.9); /* æŒ‰ä¸‹å»æœ‰ç¸®å°æ•ˆæœ */
    box-shadow: 0 0 20px var(--neon-cyan);
}

        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,5,0.9);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .menu-box {
            background: #0a0a1a; padding: 20px; border-radius: 20px; text-align: center;
            border: 2px solid var(--zombie-color); width: 80%; max-width: 280px;
        }
        .btn {
            padding: 10px; border: none; border-radius: 30px;
            background: var(--border-neon); color: #000; font-weight: bold;
            width: 100%; margin-top: 10px; cursor: pointer;
        }
/* åŠ å…¥åˆ° <style> ä¸­ */
#countdown {
    animation: zoomInOut 0.8s ease-in-out infinite;
}

@keyframes zoomInOut {
    0% { transform: scale(0.5); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
}
        #countdown {
    animation: pulse 0.8s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

        @media (min-width: 768px) { #controls { display: none; } }
    </style>
</head>
<body>

<a href="index.html" id="home-btn">å¤§å»³</a>

<div id="game-container">
    <div id="player" class="player">ğŸ‘¨â€ğŸŒ¾</div>
    <div id="countdown" style="position: absolute; inset: 0; display: none; align-items: center; justify-content: center; font-size: 80px; font-weight: 900; color: var(--neon-cyan); z-index: 100; text-shadow: 0 0 20px var(--neon-cyan);"></div>
</div>

<div id="ui-panel">
    <div class="stat"><label>é—œå¡</label><span id="level-txt">1</span></div>
    <div class="stat"><label>ç›®æ¨™</label><span id="score-txt">0 / 5</span></div>
    <div class="stat"><label>ç”Ÿå‘½</label><span>â¤ï¸</span></div>
    <div class="stat"><label>æ™‚é–“</label><span id="time-txt">60s</span></div>
</div>

<div id="controls">
    <div class="control-btn" style="grid-area: up" id="btn-up">â¬†ï¸</div>
    <div class="control-btn" style="grid-area: left" id="btn-left">â¬…ï¸</div>
    <div class="control-btn" style="grid-area: right" id="btn-right">â¡ï¸</div>
    <div class="control-btn" style="grid-area: down" id="btn-down">â¬‡ï¸</div>
</div>

<div id="overlay">
    <div class="menu-box">
        <h2 id="m-title" style="color:var(--border-neon)">éœ“è™¹è¾²å¤«</h2>
        <p id="m-text" style="font-size: 14px;">æ¡é›† ğŸŒ± ä¸¦èº²é¿ ğŸ§Ÿâ€â™€ï¸<br>æ‰‹æ©Ÿè«‹ä½¿ç”¨ä¸‹æ–¹æ–¹å‘éµ</p>
        <button id="main-btn" class="btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>
</div>

<script>
    const container = document.getElementById('game-container');
    const playerEl = document.getElementById('player');
    const scoreEl = document.getElementById('score-txt');
    const timeEl = document.getElementById('time-txt');
    const levelEl = document.getElementById('level-txt');
    const overlay = document.getElementById('overlay');
    const mainBtn = document.getElementById('main-btn');

    let pX, pY, score, timeLeft, gameActive = false;
    let level = 1;
    let zombies = [], plants = [];
    let timerInterval = null;
    
    // å‹•æ…‹ç²å–å®¹å™¨å°ºå¯¸
    let containerSize = container.clientWidth;
    window.addEventListener('resize', () => {
        containerSize = container.clientWidth;
    });

    const basePlayerSpeed = 0.015; // ä½¿ç”¨ç›¸å°æ–¼å®¹å™¨å¯¬åº¦çš„æ¯”ä¾‹
    const baseZombieSpeed = 0.003;
    
    const keys = {};
    const activeMoves = {up: false, down: false, left: false, right: false};

    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function renderPlayer() {
        // ä½¿ç”¨åƒç´ ä½ç½®ç§»å‹•
        playerEl.style.left = pX + 'px';
        playerEl.style.top = pY + 'px';
    }

   // æ–°å¢ï¼šå€’æ•¸å‡½æ•¸
    function startCountdown(callback) {
        const cdEl = document.getElementById('countdown');
        cdEl.style.display = 'flex';
        let count = 3;
        cdEl.innerText = count;

        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                cdEl.innerText = count;
            } else if (count === 0) {
                cdEl.innerText = "GO!";
            } else {
                clearInterval(timer);
                cdEl.style.display = 'none';
                callback(); // å€’æ•¸çµæŸï¼ŒåŸ·è¡ŒéŠæˆ²é–‹å§‹
            }
        }, 800);
    }

  // ä¿®æ”¹ï¼šstartGame è² è²¬åˆå§‹åŒ–èˆå°ä¸¦é–‹å§‹å€’æ•¸
    function startGame() {
        overlay.style.display = 'none';
        
        // 1. åˆå§‹åŒ–å®¹å™¨å°ºå¯¸èˆ‡ç©å®¶ä½ç½®
        containerSize = container.clientWidth;
        pX = containerSize / 2 - 15; 
        pY = containerSize / 2 - 15;
        renderPlayer();

        // 2. æ¸…é™¤èˆŠç‰©é«”ä¸¦ã€Œé å…ˆç”Ÿæˆã€æœ¬é—œçš„æ®­å±èˆ‡æ¤ç‰©
        zombies.forEach(z => z.el.remove());
        plants.forEach(p => p.el.remove());
        zombies = []; plants = [];
        
        const zombieCount = 2 + level; 
        const plantGoal = 4 + level;

        // é€™è£¡å…ˆç”Ÿæˆï¼Œè®“ç©å®¶å€’æ•¸æ™‚çœ‹å¾—åˆ°è·¯ç·š
        for(let i=0; i < zombieCount; i++) spawn('zombie');
        for(let i=0; i < plantGoal; i++) spawn('plant');
        
        // æ›´æ–°ç›®æ¨™ä»‹é¢
        score = 0;
        updateUI(plantGoal);

        // 3. é–‹å§‹å€’æ•¸ï¼ŒçµæŸå¾Œæ‰å•Ÿå‹•ç‰©ç†å¼•æ“
        startCountdown(() => {
            activateGame(plantGoal);
        });
    }

    // æ–°å¢ï¼šå€’æ•¸å‡½æ•¸ (3, 2, 1, GO)
    function startCountdown(callback) {
        const cdEl = document.getElementById('countdown');
        cdEl.style.display = 'flex';
        let count = 3;
        cdEl.innerText = count;

        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                cdEl.innerText = count;
            } else if (count === 0) {
                cdEl.innerText = "GO!";
            } else {
                clearInterval(timer);
                cdEl.style.display = 'none';
                callback(); // å€’æ•¸çµæŸï¼Œç‰©é«”é–‹å§‹ç§»å‹•
            }
        }, 800);
    }

    // ä¿®æ”¹ï¼šæ­£å¼å•Ÿå‹•éŠæˆ²è¨ˆæ™‚èˆ‡å¾ªç’°
    function activateGame(plantGoal) {
        gameActive = true;
        timeLeft = 60;
        timeEl.innerText = timeLeft + 's';

        // å•Ÿå‹•ç§»å‹•å¾ªç’°
        requestAnimationFrame(() => loop(plantGoal));
        
        // å•Ÿå‹•æ™‚é–“å€’æ•¸
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!gameActive) return;
            timeLeft--;
            timeEl.innerText = timeLeft + 's';
            if(timeLeft <= 0) end(false);
        }, 1000);
    }
    function spawn(type) {
        const el = document.createElement('div');
        el.className = type;
        el.innerText = type === 'zombie' ? 'ğŸ§Ÿâ€â™€ï¸' : 'ğŸŒ±';
        container.appendChild(el);
        let x, y;
        do {
            x = Math.random() * (containerSize - 30);
            y = Math.random() * (containerSize - 30);
        } while (Math.hypot(x - pX, y - pY) < 100);
        
        const obj = { el, x, y };
        if(type === 'zombie') zombies.push(obj); else plants.push(obj);
        el.style.left = x + 'px';
        el.style.top = y + 'px';
    }

    function loop(plantGoal) {
        if(!gameActive) return;

        const currentSpeed = (basePlayerSpeed + (level - 1) * 0.0005) * containerSize;
        const currentZSpeed = (baseZombieSpeed + (level - 1) * 0.0002) * containerSize;

        if(keys['w'] || keys['arrowup'] || activeMoves.up) pY -= currentSpeed;
        if(keys['s'] || keys['arrowdown'] || activeMoves.down) pY += currentSpeed;
        if(keys['a'] || keys['arrowleft'] || activeMoves.left) pX -= currentSpeed;
        if(keys['d'] || keys['arrowright'] || activeMoves.right) pX += currentSpeed;

        // é‚Šç•Œé™åˆ¶
        pX = Math.max(0, Math.min(containerSize - 30, pX));
        pY = Math.max(0, Math.min(containerSize - 30, pY));
        renderPlayer();

        zombies.forEach(z => {
            const dx = pX - z.x, dy = pY - z.y;
            const dist = Math.hypot(dx, dy);
            if(dist > 0) {
                z.x += (dx/dist) * currentZSpeed;
                z.y += (dy/dist) * currentZSpeed;
                z.el.style.left = z.x + 'px';
                z.el.style.top = z.y + 'px';
            }
            if(dist < 25) end(false);
        });

        plants.forEach((p, i) => {
            if(Math.hypot(pX - p.x, pY - p.y) < 30) {
                p.el.remove();
                plants.splice(i, 1);
                score++;
                updateUI(plantGoal);
                if(score >= plantGoal) end(true);
            }
        });

        requestAnimationFrame(() => loop(plantGoal));
    }

    function updateUI(goal) {
        scoreEl.innerText = `${score} / ${goal}`;
        levelEl.innerText = level;
    }

    function end(win) {
        gameActive = false;
        if(timerInterval) clearInterval(timerInterval);
        overlay.style.display = 'flex';
        const title = document.getElementById('m-title');
        const text = document.getElementById('m-text');
        
        if(win) {
            title.innerText = "Level " + level + " å®Œæˆï¼";
            text.innerHTML = `æˆåŠŸæ”¶æˆï¼é›£åº¦å¢åŠ ã€‚`;
            mainBtn.innerText = "é€²å…¥ä¸‹ä¸€å€‹é—œå¡";
            level++; 
        } else {
            title.innerText = "éŠæˆ²çµæŸ";
            text.innerHTML = `è¢«æ®­å±æŠ“åˆ°äº†...`;
            mainBtn.innerText = "é‡æ–°æŒ‘æˆ°ç¬¬ä¸€é—œ";
            level = 1; 
        }
    }

    function setupMobile(id, dir) {
        const btn = document.getElementById(id);
        btn.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            activeMoves[dir] = true; 
        }, {passive: false});
        btn.addEventListener('touchend', () => activeMoves[dir] = false);
        btn.addEventListener('touchcancel', () => activeMoves[dir] = false);
    }
    setupMobile('btn-up', 'up'); setupMobile('btn-down', 'down');
    setupMobile('btn-left', 'left'); setupMobile('btn-right', 'right');
</script>
</body>
</html>
