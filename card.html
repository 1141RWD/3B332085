<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-select=none" />
<title>å¿ƒè‡Ÿç—… Mobile</title>
<style>
  :root {
    --primary-bg: #1a1a1a;
    --active-color: #00ffcc;
    --error-color: #ff4d4d;
    --bell-red: #d32f2f;
    --pile-count-bg: #444;
  }
  body {
    background: var(--primary-bg); color: #eee;
    font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
    overflow: hidden; touch-action: manipulation;
  }
  
  /* é ‚éƒ¨è³‡è¨Š */
  #status-bar {
    display: flex; gap: 20px; margin-bottom: 10px;
    background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 50px;
  }
  #currentCount { color: var(--active-color); font-size: 24px; font-weight: bold; }

  /* ç¨ç«‹çš„ç´¯ç©å¼µæ•¸é¡¯ç¤ºå€ (ä¿è­‰ä¸è¢«é®æ“‹) */
  #pile-info-bar {
    background: var(--pile-count-bg);
    padding: 5px 20px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 2px solid #666;
    font-size: 18px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }
  #cardTotal { color: #ffeb3b; font-size: 22px; }

  /* ä¸­é–“åœ“æ¡Œå€ */
  #table-surface {
    position: relative; width: 260px; height: 260px;
    background: radial-gradient(circle, #333 0%, #111 100%);
    border-radius: 50%; border: 6px solid #444;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    margin-bottom: 15px;
  }
  #middlePile { 
    position: absolute; top: 40px; width: 80px; height: 110px; 
    z-index: 1; /* å¡ç‰Œåœ¨ä¸‹å±¤ */
  }

  /* æ‹ç‰Œéˆ´éº (ä½æ–¼å¡ç‰Œä¸‹æ–¹ï¼Œé˜²æ­¢é®æ“‹) */
  #bell-btn {
    position: absolute; bottom: 20px;
    width: 80px; height: 80px; background: var(--bell-red);
    border-radius: 50%; border: 4px solid #fff;
    z-index: 10; /* æŒ‰éˆ•åœ¨ä¸Šå±¤ */
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    font-weight: bold; font-size: 20px; color: white;
    transition: transform 0.05s, background 0.2s;
    user-select: none; -webkit-tap-highlight-color: transparent;
  }
  #bell-btn:active { transform: scale(0.9); background: #b71c1c; }

  /* å¡ç‰Œæ¨£å¼å¾®èª¿ */
  .card {
    position: absolute; width: 80px; height: 110px;
    background: white; border-radius: 8px; color: black; font-weight: bold;
    font-size: 20px; display: flex; flex-direction: column;
    justify-content: space-around; align-items: center; border: 1px solid #999;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }
  .card.joker { background: #fdf; border-color: #d0d; color: #808; }
  .red { color: #e44141; }
  
  /* ç©å®¶å€æ”¹ç‚ºå…©åˆ— */
  #players-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 450px; }
  .player-box { background: #333; padding: 10px; border-radius: 10px; text-align: center; border: 2px solid transparent; }
  .player-box.active { border-color: var(--active-color); background: #3d3d3d; }
  .player-box.penalty { border-color: var(--error-color); background: #4a2222; }
  .player-box.snapped { background: #555; }

  #message { height: 40px; font-size: 1rem; color: #ffeb3b; margin: 5px 0; text-align: center; font-weight: bold; }
  .shake { animation: shake 0.3s; }
  @keyframes shake {
    0%, 100% { transform: translate(0,0); }
    25% { transform: translate(-4px, 4px); }
    50% { transform: translate(4px, -4px); }
  }
</style>
</head>
<body>

<h1>å¿ƒè‡Ÿç—… Mobile</h1>

<div id="status-bar">
  <div>è¼ªåˆ°ï¼š<span id="pName">...</span></div>
  <div>å–Šï¼š<span id="currentCount">1</span></div>
</div>

<div id="pile-info-bar">
  æ¡Œä¸Šç´¯ç©ï¼š<span id="cardTotal">0</span> å¼µ
</div>

<div id="table-surface">
  <div id="middlePile"></div>
  <div id="bell-btn">æ‹ï¼</div>
</div>

<div id="players-grid">
  <div class="player-box" id="pBox0"><h3>ä½ </h3><div>ç‰Œï¼š<span id="cnt0">0</span></div></div>
  <div class="player-box" id="pBox1"><h3>é›»è…¦ 1</h3><div>ç‰Œï¼š<span id="cnt1">0</span></div></div>
  <div class="player-box" id="pBox2"><h3>é›»è…¦ 2</h3><div>ç‰Œï¼š<span id="cnt2">0</span></div></div>
  <div class="player-box" id="pBox3"><h3>é›»è…¦ 3</h3><div>ç‰Œï¼š<span id="cnt3">0</span></div></div>
</div>

<div id="message">é»æ“Šç´…è‰²æŒ‰éˆ•æ¶æ‹ï¼</div>

<script>
(() => {
  const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
  const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const pBoxes = [0,1,2,3].map(i => document.getElementById(`pBox${i}`));
  const middlePileDiv = document.getElementById('middlePile');
  const cardTotalSpan = document.getElementById('cardTotal');
  const bellBtn = document.getElementById('bell-btn');
  
  let state = {
    hands: [[], [], [], []],
    middle: [],
    count: 1,
    turn: 0,
    waiting: false,
    snapList: [],
    gameOver: false,
    penaltyActive: false
  };

  function init() {
    let deck = [];
    SUITS.forEach(s => RANKS.forEach(r => deck.push({s, r})));
    deck.push({s:'â˜…', r:'JOKER'}, {s:'â˜…', r:'JOKER'});
    deck.sort(() => Math.random() - 0.5);
    state.hands = [[],[],[],[]];
    deck.forEach((card, i) => state.hands[i % 4].push(card));
    updateUI();
    nextStep();
  }

  function updateUI() {
    state.hands.forEach((h, i) => {
      document.getElementById(`cnt${i}`).textContent = h.length;
      pBoxes[i].classList.toggle('active', state.turn === i && !state.gameOver);
    });
    document.getElementById('currentCount').textContent = state.count;
    cardTotalSpan.textContent = state.middle.length;
    document.getElementById('pName').textContent = state.turn === 0 ? "ä½ " : `é›»è…¦ ${state.turn}`;
    
    middlePileDiv.innerHTML = '';
    // åªé¡¯ç¤ºæœ€å¾Œ 3 å¼µç‰Œä»¥æ¸›å°‘å †ç–Šæ··äº‚ï¼Œä¸”å›ºå®šä½ç½®
    const displayLimit = 3;
    const start = Math.max(0, state.middle.length - displayLimit);
    for(let i = start; i < state.middle.length; i++){
        const card = state.middle[i];
        const cardEl = document.createElement('div');
        cardEl.className = `card ${card.r === 'JOKER' ? 'joker' : ''}`;
        if(card.s === 'â™¥' || card.s === 'â™¦') cardEl.classList.add('red');
        cardEl.innerHTML = `<div>${card.s}</div><div>${card.r}</div>`;
        // ç¨å¾®æ¸›å°‘éš¨æ©Ÿæ—‹è½‰ç¯„åœ (å¾ 20åº¦ é™åˆ° 10åº¦) é¿å…æ“‹ä½æŒ‰éˆ•
        cardEl.style.transform = `rotate(${(Math.random()*10)-5}deg)`;
        middlePileDiv.appendChild(cardEl);
    }
  }

  function playCard() {
    if(state.gameOver || state.penaltyActive) return;
    
    if(state.hands[state.turn].length === 0) {
        state.turn = (state.turn + 1) % 4;
        nextStep();
        return;
    }

    const card = state.hands[state.turn].shift();
    state.middle.push(card);
    updateUI();

    const cardVal = rankToNum(card.r);
    const isMatch = (cardVal === state.count || card.r === 'JOKER');

    if(isMatch) {
      triggerSnapPhase();
    } else {
      if(Math.random() < 0.02) {
        setTimeout(() => triggerPenalty(Math.floor(Math.random()*3)+1), 400);
        return;
      }
      state.count = state.count >= 13 ? 1 : state.count + 1;
      state.turn = (state.turn + 1) % 4;
      nextStep();
    }
  }

  function nextStep() {
    if (checkWin()) return;
    const delay = state.turn === 0 ? 1000 : 1300 + Math.random() * 800;
    setTimeout(() => { if(!state.waiting && !state.penaltyActive) playCard(); }, delay);
  }

  function triggerSnapPhase() {
    state.waiting = true;
    state.snapList = [];
    pBoxes.forEach(b => b.classList.remove('snapped'));
    
    for(let i=1; i<=3; i++) {
      const reaction = 800 + Math.random() * 1500;
      setTimeout(() => { if(state.waiting) performSnap(i); }, reaction);
    }
  }

  function performSnap(pid) {
    if(state.snapList.includes(pid) || state.gameOver) return;
    state.snapList.push(pid);
    pBoxes[pid].classList.add('snapped');
    if(state.snapList.length === 1) document.getElementById('message').textContent = `${pid === 0 ? 'ä½ ' : 'é›»è…¦'+pid} ç‡å…ˆæ‹ç‰Œï¼`;
    if(state.snapList.length === 4) resolveSnap();
  }

  function resolveSnap() {
    state.waiting = false;
    const loser = state.snapList[3];
    document.getElementById('table-surface').classList.add('shake');
    
    setTimeout(() => {
      document.getElementById('table-surface').classList.remove('shake');
      document.getElementById('message').textContent = `${loser===0?'ä½ ': 'é›»è…¦'+loser} æœ€æ…¢ï¼`;
      state.hands[loser].push(...state.middle);
      state.middle = [];
      state.count = 1;
      state.turn = loser;
      pBoxes.forEach(b => b.classList.remove('snapped'));
      updateUI();
      nextStep();
    }, 800);
  }

  function handleInput() {
    if (state.gameOver || state.penaltyActive) return;
    const topCard = state.middle[state.middle.length - 1];
    const isMatch = topCard && (rankToNum(topCard.r) === state.count || topCard.r === 'JOKER');

    if (state.waiting && isMatch) {
      performSnap(0);
    } else {
      triggerPenalty(0);
    }
  }

  function triggerPenalty(pid) {
    if(state.penaltyActive || state.gameOver) return;
    state.penaltyActive = true;
    state.waiting = false;
    pBoxes[pid].classList.add('penalty');
    document.getElementById('message').textContent = `${pid===0?'ä½ ':'é›»è…¦'+pid} èª¤æ‹å—ç½°ï¼`;
    
    setTimeout(() => {
      pBoxes[pid].classList.remove('penalty');
      state.hands[pid].push(...state.middle);
      state.middle = [];
      state.count = 1;
      state.turn = pid;
      state.penaltyActive = false;
      updateUI();
      nextStep();
    }, 1200);
  }

  function checkWin() {
    for(let i=0; i<4; i++) {
        if(state.hands[i].length === 0 && !state.waiting && !state.penaltyActive && state.middle.length === 0) {
            document.getElementById('message').textContent = `ğŸ† ${i===0?'ä½ ': 'é›»è…¦'+i} ç²å‹ï¼`;
            state.gameOver = true;
            return true;
        }
    }
    return false;
  }

  function rankToNum(r) {
    if(r==='A') return 1; if(r==='J') return 11;
    if(r==='Q') return 12; if(r==='K') return 13;
    if(r==='JOKER') return -1;
    return parseInt(r);
  }

  bellBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });
  bellBtn.addEventListener('click', handleInput);
  window.addEventListener('keydown', e => { if(e.code === 'Space') handleInput(); });

  init();
})();
</script>
</body>
</html>
